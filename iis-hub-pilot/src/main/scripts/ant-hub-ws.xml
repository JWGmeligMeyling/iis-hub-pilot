<?xml version="1.0" encoding="UTF-8"?>
<project
    name="hub-ws"
    xmlns="antlib:org.apache.tools.ant"
    xmlns:hub="antlib:gov.hhs.onc.iishubpilot.ant"
    xmlns:hub-java="antlib:gov.hhs.onc.iishubpilot.ant.java"
    xmlns:res-cmp="antlib:org.apache.tools.ant.types.resources.comparators"
    xmlns:res-sel="antlib:org.apache.tools.ant.types.resources.selectors">
    
    <description>Ant project for Immunization Information Services (IIS) Hub Pilot web service related components.</description>
    
    <import file="ant-hub.xml" as="" prefixSeparator=""/>
    
    <target name="hub-ws-process-sources" depends="hub-init,hub-ws-init">
        <delete quiet="true">
            <fileset dir="${project.build.cxfSourceDirectory}">
                <patternset refid="patternset.java.pkg.info.files"/>
                <patternset refid="patternset.java.jaxws.service.files"/>
            </fileset>
        </delete>
        
        <for param="cxf.factory.file">
            <path>
                <fileset dir="${project.build.cxfSourceDirectory}">
                    <patternset refid="patternset.java.jaxb.factory.context.files"/>
                    <patternset refid="patternset.java.jaxb.factory.obj.files"/>
                </fileset>
            </path>
            <sequential>
                <hub-java:suppress-class-warnings file="@{cxf.factory.file}" warnings="rawtypes,unchecked"/>
            </sequential>
        </for>
        
        <for param="cxf.factory.obj.file">
            <path>
                <fileset dir="${project.build.cxfSourceDirectory}">
                    <patternset refid="patternset.java.jaxb.factory.obj.files"/>
                </fileset>
            </path>
            <sequential>
                <hub:filter-file file="@{cxf.factory.obj.file}">
                    <tokenfilter>
                        <scriptfilter language="javascript" classpath="${maven.classpath}"><![CDATA[
                            var token = self.getToken(), tokenMatches;
                            
                            if ((tokenMatches = /^(\s+)private(\s+final\s+static\s+QName\s+)_(\w+)(_QNAME\s+=\s+[^$]+$)/.exec(token)) !== null) {
                                token = tokenMatches[1] + "public" + tokenMatches[2] + tokenMatches[3].replace(/([a-z])([A-Z])/g, "$1_$2").toUpperCase() +
                                    tokenMatches[4];
                            } else if ((tokenMatches = /^([^$]+)_(\w+)(_QNAME[^$]+)$/.exec(token)) !== null) {
                                token = tokenMatches[1] + tokenMatches[2].replace(/([a-z])([A-Z])/g, "$1_$2").toUpperCase() + tokenMatches[3];
                            }
                            
                            self.setToken(token);
                        ]]></scriptfilter>
                    </tokenfilter>
                </hub:filter-file>
            </sequential>
        </for>
    </target>
    
    <target name="hub-ws-init">
        <patternset id="patternset.java.pkg.info.files">
            <include name="**/package-info.java"/>
        </patternset>
        <patternset id="patternset.java.jaxb.factory.context.files">
            <include name="**/JAXBContextFactory.java"/>
        </patternset>
        <patternset id="patternset.java.jaxb.factory.obj.files">
            <include name="**/ObjectFactory.java"/>
        </patternset>
        <patternset id="patternset.java.jaxws.service.files">
            <include name="**/IIS*Service.java"/>
        </patternset>
    </target>
</project>